<html>
<head>
    <meta charset="UTF-8">
    <title>ë©€í‹° ì—ì„ ì—°ìŠµê¸°</title>
    <style>
        body {
            user-select: none;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .target {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: red;
            position: absolute;
            cursor: pointer;
        }
        #score, #timer {
            position: fixed;
            top: 10px;
            color: black;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
        }
        #score { left: 10px; }
        #timer { right: 10px; }

        #controls {
            position: fixed;
            top: 50px;
            left: 10px;
            display: flex;
            gap: 6px;
            z-index: 1000;
        }
        #controls button {
            padding: 4px 10px;
            font-size: 0.9rem;
        }

        #leaderboard {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 10px;
            border-radius: 4px;
            max-width: 280px;
            font-size: 0.9rem;
            z-index: 1000;
        }
        #leaderboard h3 {
            margin: 0 0 4px 0;
            font-size: 1rem;
        }
        #leaderboard ol {
            margin: 0;
            padding-left: 18px;
        }
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            display: none;
            z-index: 1000;
        }

        .hit-effect {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 3px solid rgba(0, 255, 0, 0.8);
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: hit-burst 0.4s ease-out forwards;
            z-index: 900;
        }
        @keyframes hit-burst {
            0% {
                transform: translate(-50%, -50%) scale(0.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2.0);
                opacity: 0;
            }
        }

        .miss-x {
            position: absolute;
            width: 24px;
            height: 24px;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 900;
            opacity: 0;
            animation: miss-pop 0.5s ease-out forwards;
        }
        .miss-x::before,
        .miss-x::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 24px;
            height: 3px;
            background: rgba(255, 0, 0, 0.9);
            transform-origin: center;
        }
        .miss-x::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .miss-x::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        @keyframes miss-pop {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.6);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }
    </style>
</head>
<body>
<div id="score">ì ìˆ˜: 0</div>
<div id="timer">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</div>

<div id="controls">
    <button id="endBtn">ê²Œì„ ì¢…ë£Œ</button>
    <button id="pauseBtn">ì¼ì‹œì •ì§€</button>
    <button id="restartBtn">ë‹¤ì‹œ ì‹œì‘</button>

    <!-- ë‚œì´ë„ ì¡°ì ˆ ë°” -->
    <div style="margin-left: 10px; color: black; font-size: 0.8rem;">
        ë™ì‹œ íƒ€ê²Ÿ ìˆ˜:
        <input id="targetCountRange" type="range" min="1" max="5" value="2">
        <span id="targetCountValue">2</span>ê°œ
        <br>
        ìƒì„± ì†ë„:
        <input id="speedRange" type="range" min="1" max="5" value="3">
        <span id="speedValue">ë³´í†µ</span>
    </div>
</div>

<div id="leaderboard">
    <h3>ìˆœìœ„í‘œ (ìƒìœ„ 10ëª…)</h3>
    <ol id="rankList"></ol>
</div>
<div id="message"></div>

<script>
  // ===== 1. JSONBin ì„¤ì • =====
  const BIN_URL = 'https://api.jsonbin.io/v3/b/6960665fd0ea881f405e7924/latest';
  const API_KEY = '$2a$10$Zc5XwU66u39U6RrTpM.r8Osz3tfGMVonD4SVE2GwTP81.d3sd/pyi';

  async function addScoreToBin(name, score) {
    try {
      const getRes = await fetch(BIN_URL, {
        headers: { 'X-Master-Key': API_KEY }
      });
      const data = await getRes.json();
      const record = data.record || data;
      const list = Array.isArray(record.scores) ? record.scores : [];

      list.push({ name, score });

      const newRecord = { ...record, scores: list };
      const putUrl = BIN_URL.replace('/latest', '');
      await fetch(putUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': API_KEY
        },
        body: JSON.stringify(newRecord)
      });
    } catch (e) {
      console.error('addScoreToBin error', e);
    }
  }

  async function getTop10FromBin() {
    try {
      const res = await fetch(BIN_URL, {
        headers: { 'X-Master-Key': API_KEY }
      });
      const data = await res.json();
      const record = data.record || data;
      const list = Array.isArray(record.scores) ? record.scores : [];

      list.sort((a, b) => b.score - a.score);
      return list.slice(0, 10);
    } catch (e) {
      console.error('getTop10FromBin error', e);
      return [];
    }
  }

  // ì¢Œì¸¡ í•˜ë‹¨ ìˆœìœ„í‘œ (1~10ìœ„, 1~3ìœ„ ì™•ê´€ ê°•ì¡°)
  async function renderRanking() {
    const scores = await getTop10FromBin();
    const listEl = document.getElementById('rankList');
    if (!listEl) return;

    listEl.innerHTML = '';
    scores.forEach((item, idx) => {
      const li = document.createElement('li');

      let prefix = '';
      if (idx === 0) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '900';
        li.style.fontSize = '1.1rem';
        li.style.color = '#d4af37';
      } else if (idx === 1) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '800';
        li.style.fontSize = '1.05rem';
        li.style.color = '#c0c0c0';
      } else if (idx === 2) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '800';
        li.style.fontSize = '1.02rem';
        li.style.color = '#cd7f32';
      } else {
        li.style.opacity = '0.9';
      }

      li.textContent = `${prefix}${item.name}: ${item.score}`;
      listEl.appendChild(li);
    });
  }

  // ===== 2. ê²Œì„ ìƒíƒœ =====
  let score = 0;
  let timeLeft = 30;
  let timerId = null;
  let isRunning = false;

  // ë‚œì´ë„ (ìŠ¬ë¼ì´ë”ë¡œ ì¡°ì ˆë˜ëŠ” ê°’)
  let maxTargets = 2;            // ë™ì‹œì— ë‚˜ì˜¤ëŠ” íƒ€ê²Ÿ ìˆ˜
  let minSpawnInterval = 600;    // ìƒì„± ê°„ê²© ìµœì†Œ(ms)
  let maxSpawnInterval = 1400;   // ìƒì„± ê°„ê²© ìµœëŒ€(ms)

  const targetLifeMin = 900;     // íƒ€ê²Ÿ ìµœì†Œ ìƒì¡´ì‹œê°„(ms)
  const targetLifeMax = 2200;    // íƒ€ê²Ÿ ìµœëŒ€ ìƒì¡´ì‹œê°„(ms)

  const starChance = 0.12;       // ë³„ í™•ë¥ 
  const maxStarsPerGame = 5;     // ê²Œì„ë‹¹ ìµœëŒ€ ë³„ ê°œìˆ˜
  let starsSpawnedThisGame = 0;

  let spawnTimeoutId = null;

  function updateUI() {
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    if (scoreEl) scoreEl.textContent = `ì ìˆ˜: ${score}`;
    if (timerEl) timerEl.textContent = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
  }

  function randomBetween(min, max) {
    return Math.random() * (max - min) + min;
  }

  // ìŠ¬ë¼ì´ë” â†’ ë‚œì´ë„ ì ìš©
  function applyDifficultyFromSliders() {
    const countRange = document.getElementById('targetCountRange');
    const speedRange = document.getElementById('speedRange');
    const countValue = document.getElementById('targetCountValue');
    const speedValue = document.getElementById('speedValue');
    if (!countRange || !speedRange) return;

    const count = Number(countRange.value); // 1~5
    const speed = Number(speedRange.value); // 1~5

    maxTargets = count;
    if (countValue) countValue.textContent = String(count);

    let minMs, maxMs;
    switch (speed) {
      case 1:
        minMs = 1200; maxMs = 2200; if (speedValue) speedValue.textContent = 'ë§¤ìš° ëŠë¦¼'; break;
      case 2:
        minMs = 900;  maxMs = 1800; if (speedValue) speedValue.textContent = 'ëŠë¦¼'; break;
      case 3:
        minMs = 600;  maxMs = 1400; if (speedValue) speedValue.textContent = 'ë³´í†µ'; break;
      case 4:
        minMs = 350;  maxMs = 900;  if (speedValue) speedValue.textContent = 'ë¹ ë¦„'; break;
      case 5:
      default:
        minMs = 200;  maxMs = 700;  if (speedValue) speedValue.textContent = 'ë§¤ìš° ë¹ ë¦„'; break;
    }
    minSpawnInterval = minMs;
    maxSpawnInterval = maxMs;
  }

  function spawnTargetOnce() {
    if (!isRunning) return;

    const currentTargets = document.querySelectorAll('.target').length;
    if (currentTargets >= maxTargets) {
      scheduleNextSpawn();
      return;
    }

    let isStar = false;
    if (starsSpawnedThisGame < maxStarsPerGame) {
      if (Math.random() < starChance) {
        isStar = true;
        starsSpawnedThisGame++;
      }
    }

    const target = document.createElement('div');
    target.className = 'target';

    const size = isStar ? 30 : 40;
    const maxX = window.innerWidth - size;
    const maxY = window.innerHeight - size;
    const x = Math.random() * maxX;
    const y = Math.random() * maxY;

    target.style.width = `${size}px`;
    target.style.height = `${size}px`;
    target.style.left = `${x}px`;
    target.style.top = `${y}px`;

    if (isStar) {
      target.style.background = 'gold';
      target.style.borderRadius = '50%';
      target.style.boxShadow = '0 0 8px rgba(255, 215, 0, 0.9)';
      target.textContent = 'â˜…';
      target.style.color = 'black';
      target.style.display = 'flex';
      target.style.alignItems = 'center';
      target.style.justifyContent = 'center';
      target.style.fontSize = '18px';
      target.dataset.star = 'true';
    } else {
      target.style.background = 'red';
    }

    target.addEventListener('click', (e) => {
      if (!isRunning) return;

      if (target.dataset.star === 'true') {
        score += 3;
      } else {
        score += 1;
      }
      updateUI();
      createHitEffect(e.clientX, e.clientY);
      target.remove();
    });

    document.body.appendChild(target);

    const life = randomBetween(targetLifeMin, targetLifeMax);
    setTimeout(() => {
      if (document.body.contains(target)) {
        target.remove();
      }
    }, life);

    scheduleNextSpawn();
  }

  function scheduleNextSpawn() {
    if (!isRunning) return;
    const delay = randomBetween(minSpawnInterval, maxSpawnInterval);
    spawnTimeoutId = setTimeout(spawnTargetOnce, delay);
  }

  function createHitEffect(x, y) {
    const effect = document.createElement('div');
    effect.className = 'hit-effect';
    effect.style.left = `${x}px`;
    effect.style.top = `${y}px`;
    document.body.appendChild(effect);
    setTimeout(() => effect.remove(), 400);
  }

  function createMissEffect(x, y) {
    const miss = document.createElement('div');
    miss.className = 'miss-x';
    miss.style.left = `${x}px`;
    miss.style.top = `${y}px`;
    document.body.appendChild(miss);
    setTimeout(() => miss.remove(), 500);
  }

  function removeAllTargets() {
    document.querySelectorAll('.target').forEach(t => t.remove());
  }

  function showMessage(text) {
    const msg = document.getElementById('message');
    if (!msg) return;
    msg.textContent = text;
    msg.style.display = 'block';
  }

  function hideMessage() {
    const msg = document.getElementById('message');
    if (!msg) return;
    msg.style.display = 'none';
  }

  // ===== 3. ì‹œì‘/ì¼ì‹œì •ì§€/ì¢…ë£Œ =====
  function startGame() {
    if (isRunning) return;
    isRunning = true;
    score = 0;
    timeLeft = 30;
    starsSpawnedThisGame = 0;
    updateUI();

    hideMessage();
    removeAllTargets();

    if (timerId) clearInterval(timerId);
    timerId = setInterval(() => {
      timeLeft--;
      updateUI();
      if (timeLeft <= 0) {
        endGame();
      }
    }, 1000);

    if (spawnTimeoutId) clearTimeout(spawnTimeoutId);
    scheduleNextSpawn();
  }

  function pauseGame() {
    if (!isRunning) return;
    isRunning = false;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
    if (spawnTimeoutId) {
      clearTimeout(spawnTimeoutId);
      spawnTimeoutId = null;
    }
  }

  function endGame() {
    if (!isRunning && timeLeft <= 0) return;
    isRunning = false;

    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
    if (spawnTimeoutId) {
      clearTimeout(spawnTimeoutId);
      spawnTimeoutId = null;
    }

    removeAllTargets();

    const name = prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”') || 'noname';
    addScoreToBin(name, score).then(() => {
      renderRanking().then(() => {
        updatePopupRanking();
      });
    });

    showMessage(`ê²Œì„ ì¢…ë£Œ! ì ìˆ˜: ${score}`);
    showStartOverlay();
  }

  document.addEventListener('click', (e) => {
    const isTarget = e.target.classList.contains('target');
    const isButton = e.target.tagName === 'BUTTON';
    const isOverlay = e.target.id === 'startOverlay' || e.target.id === 'startButton';
    if (!isTarget && !isButton && !isOverlay && isRunning) {
      createMissEffect(e.clientX, e.clientY);
    }
  });

  // ===== 4. ì‹œì‘ íŒì—… + í° ë­í‚¹ =====
  function createStartOverlayIfNeeded() {
    if (document.getElementById('startOverlay')) return;

    const overlay = document.createElement('div');
    overlay.id = 'startOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    overlay.style.background = 'rgba(0,0,0,0.4)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '1200';

    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'row';
    container.style.alignItems = 'flex-start';
    container.style.justifyContent = 'center';
    container.style.gap = '40px';

    const startBtn = document.createElement('button');
    startBtn.id = 'startButton';
    startBtn.textContent = 'ì‹œì‘!!';
    startBtn.style.fontSize = '2.2rem';
    startBtn.style.fontWeight = 'bold';
    startBtn.style.padding = '18px 36px';
    startBtn.style.borderRadius = '10px';
    startBtn.style.border = 'none';
    startBtn.style.cursor = 'pointer';

    startBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      startGame();
    });

    const popupRankBox = document.createElement('div');
    popupRankBox.id = 'popupRankBox';
    popupRankBox.style.background = 'rgba(255,255,255,0.97)';
    popupRankBox.style.padding = '14px 18px';
    popupRankBox.style.borderRadius = '10px';
    popupRankBox.style.minWidth = '260px';
    popupRankBox.style.maxHeight = '70vh';
    popupRankBox.style.overflowY = 'auto';
    popupRankBox.style.fontSize = '1rem';

    const title = document.createElement('div');
    title.textContent = 'ë­í‚¹ (1~10ìœ„)';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '6px';
    title.style.fontSize = '1.1rem';

    const ol = document.createElement('ol');
    ol.id = 'popupRankList';
    ol.style.margin = '0';
    ol.style.paddingLeft = '20px';

    popupRankBox.appendChild(title);
    popupRankBox.appendChild(ol);

    container.appendChild(startBtn);
    container.appendChild(popupRankBox);
    overlay.appendChild(container);
    document.body.appendChild(overlay);
  }

  async function updatePopupRanking() {
    const scores = await getTop10FromBin();
    const popupList = document.getElementById('popupRankList');
    if (!popupList) return;

    popupList.innerHTML = '';
    scores.forEach((item, idx) => {
      const li = document.createElement('li');

      let prefix = '';
      if (idx === 0) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '900';
        li.style.fontSize = '1.4rem';
        li.style.color = '#d4af37';
      } else if (idx === 1) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '800';
        li.style.fontSize = '1.25rem';
        li.style.color = '#c0c0c0';
      } else if (idx === 2) {
        prefix = 'ğŸ‘‘ ';
        li.style.fontWeight = '800';
        li.style.fontSize = '1.18rem';
        li.style.color = '#cd7f32';
      } else {
        li.style.fontWeight = '500';
        li.style.fontSize = '1rem';
        li.style.opacity = '0.9';
      }

      li.textContent = `${prefix}${item.name}: ${item.score}`;
      popupList.appendChild(li);
    });
  }

  function showStartOverlay() {
    createStartOverlayIfNeeded();
    const overlay = document.getElementById('startOverlay');
    if (overlay) {
      overlay.style.display = 'flex';
      updatePopupRanking();
    }
  }

  // ===== 5. ì´ˆê¸°í™” =====
  window.addEventListener('load', () => {
    const endBtn = document.getElementById('endBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');

    if (endBtn) endBtn.addEventListener('click', endGame);
    if (pauseBtn) pauseBtn.addEventListener('click', pauseGame);
    if (restartBtn) restartBtn.style.display = 'none';

    const countRange = document.getElementById('targetCountRange');
    const speedRange = document.getElementById('speedRange');
    if (countRange) countRange.addEventListener('input', applyDifficultyFromSliders);
    if (speedRange) speedRange.addEventListener('input', applyDifficultyFromSliders);
    applyDifficultyFromSliders();

    updateUI();
    renderRanking().then(() => {
      showStartOverlay();
    });
  });
</script>
</body>
</html>
